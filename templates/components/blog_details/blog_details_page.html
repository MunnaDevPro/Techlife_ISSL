{% extends 'base.html' %}
{% load static %} 
 {% load humanize %}
{% block content %}

<header class="max-w-7xl mx-auto pr-16 pl-16 mt-4">
    <i class="fa-solid fa-house"></i>
    <span class="text-sm text-gray-600 pl-2">Bangladesh</span>
    <span class="text-sm text-gray-600 mx-1">/</span>
    <a class="text-sm text-gray-600 hover:text-blue-600 cursor-pointer">{{ blog_detail.category.name }}</a>
</header>

<div class="max-w-7xl mx-auto pr-16 pl-16">
    <div class="flex flex-col md:flex-row md:space-x-8">
        <main class="w-full md:w-2/3 blog-content-area">
            <div class="details">
                <!-- Title -->
                <h1 id="blog-title" class="font-inter font-semibold pt-2 text-3xl sm:text-2xl md:text-3xl text-gray-900 leading-tight">{{ blog_detail.title }}</h1>

                <!-- Social icons area -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center font-inter mt-3 border-t border-gray-200 pt-2 space-y-2 sm:space-y-0">
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                        <span>
                            <i class="fa-solid fa-user pr-2"></i>
                            {{ blog_detail.author.first_name }} {{ blog_detail.author.last_name }}
                        </span>
                        <span>
                            <i class="fa-solid fa-eye pt-[5px]"></i>
                            {{ blog_detail.views }}
                        </span>

                        <span class="flex flex-row gap-[5px] pt-1">
                            <svg class="pt-[1px]" width="13" height="20" viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M9.51768 8.96851C8.95518 8.96851 8.44393 9.19851 8.07227 9.57018L4.19727 7.36685C4.24893 7.18768 4.2856 7.00185 4.2856 6.80685C4.2856 6.61102 4.24977 6.42518 4.19893 6.2456L8.06143 4.04935C8.43393 4.42602 8.94977 4.66102 9.51768 4.66102C10.661 4.66102 11.5852 3.73643 11.5852 2.60893C11.5852 1.46518 10.661 0.541016 9.51768 0.541016C8.38977 0.541016 7.4656 1.46518 7.4656 2.60893C7.4656 2.78727 7.49602 2.95768 7.53935 3.12352L3.70727 5.37643C3.33143 4.98477 2.80477 4.73935 2.2181 4.73935C1.09018 4.73935 0.166016 5.6631 0.166016 6.80685C0.166016 7.93476 1.09018 8.85851 2.2181 8.85851C2.8006 8.85851 3.32435 8.61726 3.69977 8.23268L7.54602 10.4943C7.49893 10.6681 7.4656 10.8473 7.4656 11.036C7.4656 12.1639 8.38977 13.0881 9.51768 13.0881C10.661 13.0881 11.5852 12.1639 11.5852 11.036C11.5852 9.89268 10.661 8.96851 9.51768 8.96851"></path>
                            </svg>
                            <span class="font-semibold">{{ blog_detail.shares.count }}</span>
                        </span>
                    </div>

                    <!-- Social Icons -->
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="flex w-8 h-8 border rounded-full border-[#1877F2] justify-center items-center hover:bg-[#1877F2] hover:text-white">
                            <a href="#" class="text-[#1877F2] hover:text-white"><i class="fa-brands fa-facebook-f"></i></a>
                        </div>
                        <div class="flex w-8 h-8 border rounded-full border-[#1DA1F2] justify-center items-center hover:bg-[#1DA1F2] hover:text-white">
                            <a href="#" class="text-[#1DA1F2] hover:text-white"><i class="fa-brands fa-x-twitter"></i></a>
                        </div>
                        <div class="flex w-8 h-8 border rounded-full border-[#0A66C2] justify-center items-center hover:bg-[#0A66C2] hover:text-white">
                            <a href="#" class="text-[#0A66C2] hover:text-white"><i class="fa-brands fa-linkedin-in"></i></a>
                        </div>
                        <div class="flex w-8 h-8 border rounded-full border-[#25D366] justify-center items-center hover:bg-[#25D366] hover:text-white">
                            <a href="#" class="text-[#25D366] hover:text-white"><i class="fa-brands fa-whatsapp"></i></a>
                        </div>
                        <div class="flex w-8 h-8 border rounded-full border-gray-400 justify-center items-center hover:bg-gray-500 hover:text-white">
                            <a href="#" class="text-gray-500 hover:text-white"><i class="fa-solid fa-print"></i></a>
                        </div>
                    </div>
                </div>

                <!-- Blog Image -->
                <div class="relative mt-3">
                    <img class="w-full h-auto object-cover rounded-md" src="{{ blog_detail.featured_image_url }}" alt="AI chip" />
                </div>

                <!-- Author + Share + Save -->
                <div class="mt-2 flex flex-col sm:flex-row items-start sm:items-center justify-between border-b-[1px] border-e-gray-200 space-y-2 sm:space-y-0">
                    <div>
                        <span class="text-blue-600 font-extrabold">
                            TL
                            <span class="text-gray-900 ml-1 font-bold">Techlife Report</span>
                        </span>
                    </div>

                    <div class="flex items-center py-1 cursor-pointer">
                        <div class="audio-controls flex items-center gap-2 group rounded-sm px-2 hover:border-blue-500 transition-all duration-500">
                            <button id="main-audio-btn" class="flex items-center gap-1 border border-gray-300 px-2 rounded-xl" title="Listen">
                                <span class="font-inter text-gray-500 text-[12px] group-hover:text-blue-500 transition-all duration-300">Listen</span>
                                <span id="icon-display" class="text-gray-700 text-[16px] group-hover:text-blue-500 animate-float">▶</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between text-sm text-gray-600 mt-2 space-y-2 sm:space-y-0">
                    <div>
                        <span class="mr-4">Publish : {{ blog_detail.created_at|date:"d, M Y" }}</span>
                        |
                        <span>Update : {{ blog_detail.updated_at|date:"d, M Y" }}</span>
                    </div>

                    <div class="flex flex-wrap items-center space-x-2 text-gray-600 font-semibold text-[13px] pr-2">
                        <!-- Share Button -->
                        <span id="shareBtn" class="flex items-center space-x-1 cursor-pointer hover:text-gray-800">
                            <span>Share</span>
                            <svg width="14" height="20" viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M9.51768 8.96851C8.95518 8.96851 8.44393 9.19851 8.07227 9.57018L4.19727 7.36685C4.24893 7.18768 4.2856 7.00185 4.2856 6.80685C4.2856 6.61102 4.24977 6.42518 4.19893 6.2456L8.06143 4.04935C8.43393 4.42602 8.94977 4.66102 9.51768 4.66102C10.661 4.66102 11.5852 3.73643 11.5852 2.60893C11.5852 1.46518 10.661 0.541016 9.51768 0.541016C8.38977 0.541016 7.4656 1.46518 7.4656 2.60893C7.4656 2.78727 7.49602 2.95768 7.53935 3.12352L3.70727 5.37643C3.33143 4.98477 2.80477 4.73935 2.2181 4.73935C1.09018 4.73935 0.166016 5.6631 0.166016 6.80685C0.166016 7.93476 1.09018 8.85851 2.2181 8.85851C2.8006 8.85851 3.32435 8.61726 3.69977 8.23268L7.54602 10.4943C7.49893 10.6681 7.4656 10.8473 7.4656 11.036C7.4656 12.1639 8.38977 13.0881 9.51768 13.0881C10.661 13.0881 11.5852 12.1639 11.5852 11.036C11.5852 9.89268 10.661 8.96851 9.51768 8.96851"></path>
                            </svg>
                        </span>

                        <!-- Share Modal -->
                        <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
                            <div class="bg-white rounded-xl p-6 w-80 relative shadow-lg">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Share this post</h2>
                                <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>

                                <div class="flex flex-col gap-3">
                                    <a href="#" class="share-link flex items-center gap-3 p-2 rounded hover:bg-gray-100" data-platform="facebook">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="28" width="28" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve">
                                            <path fill="#1877F2" d="M16,0L16,0c8.837,0,16,7.163,16,16l0,0c0,8.837-7.163,16-16,16l0,0C7.163,32,0,24.837,0,16l0,0 C0,7.163,7.163,0,16,0z"></path>
                                            <path fill="#FFFFFF" d="M18,17.5h2.5l1-4H18v-2c0-1.03,0-2,2-2h1.5V6.14C21.174,6.097,19.943,6,18.643,6C15.928,6,14,7.657,14,10.7 v2.8h-3v4h3V26h4V17.5z"></path>
                                        </svg>
                                        Facebook
                                    </a>
                                    <a href="#" class="share-link flex items-center gap-3 p-2 rounded hover:bg-gray-100" data-platform="linkedin">
                                        <svg height="28" width="28" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve">
                                            <path fill="#0072B1" d="M16,0L16,0c8.837,0,16,7.163,16,16l0,0c0,8.837-7.163,16-16,16l0,0C7.163,32,0,24.837,0,16l0,0 C0,7.163,7.163,0,16,0z"></path>
                                            <path fill="#FFFFFF" d="M11.333,9.667c0,0.442-0.176,0.866-0.489,1.178c-0.313,0.312-0.737,0.488-1.179,0.488 c-0.442,0-0.866-0.176-1.178-0.489C8.175,10.532,8,10.108,8,9.666C8,9.224,8.176,8.8,8.489,8.488C8.801,8.175,9.225,8,9.667,8 c0.442,0,0.866,0.176,1.178,0.489S11.333,9.225,11.333,9.667L11.333,9.667z M11.383,12.567H8.05V23h3.333V12.567z M16.649,12.567 h-3.316V23h3.283v-5.475c0-3.05,3.975-3.333,3.975,0V23h3.291v-6.608c0-5.141-5.883-4.95-7.266-2.425L16.649,12.567L16.649,12.567z"></path>
                                        </svg>
                                        LinkedIn
                                    </a>
                                    <a href="#" class="share-link flex items-center gap-3 p-2 rounded hover:bg-gray-100" data-platform="twitter">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve" height="28" width="28">
                                            <circle fill="#0F1419" cx="12" cy="12" r="12"></circle>
                                            <path
                                                fill="#FFFFFF"
                                                d="M15.531,7h1.662l-3.63,4.236L17.833,17h-3.343l-2.62-3.495L8.876,17H7.212l3.882-4.531L7,7h3.427
l2.366,3.195L15.531,7z M14.947,15.986h0.92L9.926,7.962H8.937L14.947,15.986z"></path>
                                        </svg>
                                        Twitter
                                    </a>
                                    <a href="#" class="share-link flex items-center gap-3 p-2 rounded hover:bg-gray-100" data-platform="whatsapp">
                                        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 28 28" width="28" height="28">
                                            <circle id="Ellipse_3" fill="#4AC959" cx="14" cy="14" r="13.5"></circle>
                                            <path id="Path_525" fill="#ffffff" d="M19.6,8.3c-3.1-3.1-8.1-3.1-11.2,0c-2.5,2.5-3,6.5-1.3,9.6L6,22l4.2-1.1c1.2,0.6,2.5,1,3.8,1l0,0 c4.4,0.1,7.9-3.4,8-7.8C22,11.9,21.2,9.8,19.6,8.3L19.6,8.3z M14,20.5c-1.2,0-2.3-0.3-3.4-0.9l-0.2-0.1l-2.5,0.7l0.7-2.4l-0.2-0.2 c-1.9-3.1-0.9-7.2,2.2-9.1c3.1-1.9,7.2-0.9,9.1,2.2c0.6,1,0.9,2.2,1,3.3C20.6,17.6,17.7,20.5,14,20.5z M17.6,15.6 c-0.2-0.1-1.2-0.6-1.4-0.6s-0.3-0.1-0.4,0.1s-0.5,0.6-0.6,0.8S15,16,14.8,15.9c-1.1-0.5-2.1-1.3-2.7-2.4c-0.2-0.4,0.2-0.3,0.6-1.1 c0.1-0.1,0-0.2,0-0.3C12.6,12,12.2,11,12,10.6s-0.3-0.3-0.4-0.3s-0.2,0-0.4,0c-0.2,0-0.4,0.1-0.5,0.2c-0.5,0.4-0.7,1-0.7,1.7 c0.1,0.7,0.3,1.5,0.8,2.1c0.9,1.3,2,2.3,3.4,3c0.7,0.4,1.6,0.6,2.4,0.5c0.6-0.1,1-0.5,1.3-0.9c0.1-0.3,0.2-0.6,0.1-0.9 C17.9,15.7,17.8,15.7,17.6,15.6L17.6,15.6z"></path>
                                        </svg>
                                        WhatsApp
                                    </a>
                                </div>
                            </div>
                        </div>

                        {% comment %} save funtion {% endcomment %}
                        <!-- Save Button -->

                        <!-- Save Button -->
                        <span x-data="saveModalHandler({{ blog_detail.id }}, {{ user.is_authenticated|yesno:'true,false' }})">
                            <span @click="checkAndOpen()" class="flex items-center space-x-1 cursor-pointer hover:text-gray-800">
                                <span>Save</span>
                                <svg width="14" height="20" viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                                    <path d="M5.99996 9.43351L9.46496 11.0741L9.46496 2.0125L2.53496 2.0125L2.53496 11.0741L5.99996 9.43351ZM0.959961 13.5625L0.959961 0.4375L11.04 0.4375L11.04 13.5625L5.99996 11.1761L0.959961 13.5625Z" />
                                </svg>
                            </span>

                            <!-- Modal + Toast -->
                            <template x-teleport="body">
                                <!-- Modal -->
                                <div x-show="modalOpen" x-cloak class="fixed inset-0 z-[99] flex items-center justify-center w-screen h-screen">
                                    <div @click="modalOpen=false" x-transition.opacity class="absolute inset-0 w-full h-full bg-black/50 backdrop-blur-sm"></div>
                                    <div x-show="modalOpen" x-trap.inert.noscroll x-transition.scale class="relative bg-white rounded-xl p-6 w-80 shadow-lg sm:max-w-lg">
                                        <h2 class="text-xl font-bold mb-4 text-gray-800" x-text="userAuthenticated ? 'Save for later' : 'Sign in to save for later'"></h2>
                                        <div class="flex justify-end gap-3">
                                            <template x-if="userAuthenticated">
                                                <div>
                                                    <button @click="modalOpen=false" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
                                                    <button @click="savePost()" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">OK</button>
                                                </div>
                                            </template>
                                            <template x-if="!userAuthenticated">
                                                <div class="flex gap-3">
                                                    <!-- Sign In Button -->
                                                    <a href="" class="px-4 py-2 rounded-md bg-blue-600 text-white font-medium shadow-sm hover:bg-blue-700 transition-colors duration-200">Sign In</a>

                                                    <!-- Register Button -->
                                                    <a href="" class="px-4 py-2 rounded-md bg-green-600 text-white font-medium shadow-sm hover:bg-green-700 transition-colors duration-200">Register</a>
                                                </div>
                                            </template>
                                        </div>
                                        <button @click="modalOpen=false" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                                    </div>
                                </div>

                                <!-- Toast -->
                                <div x-show="toastOpen" x-transition class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded shadow-lg z-50">
                                    <span x-text="toastMessage"></span>
                                </div>
                            </template>
                        </span>
                    </div>
                </div>

                <!-- Blog Description -->
                <div id="blog-description" class="article-body mt-6 space-y-5 text-gray-800 font-serif-custom">
                    <p>{{ blog_detail.description|linebreaksbr }}</p>
                </div>

                {% comment %} add section {% endcomment %}
                <div class="flex justify-center items-center bg-gray-200 w-full mx-auto h-[100px] mt-6">
                    <p class="text-gray-500 text-center">Google adds (size not define)</p>
                </div>

                <!--  Comment Section -->
                <section id="comments" class="mt-12 border-t border-gray-200 pt-8 font-inter">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
                        <h2 class="text-xl font-bold text-gray-700">Total Comments ({{ total_comments }})</h2>

                        <!-- Sort dropdown -->
                        <div class="relative w-full sm:w-auto">
                            <select id="sort-comments" class="w-full sm:w-auto border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 focus:outline-none cursor-pointer">
                                <option value="newest" selected>Newest</option>
                                <option value="oldest">Oldest</option>
                                <option value="recent">Recently</option>
                            </select>
                        </div>
                    </div>

                    <!-- Comment Form -->
                    {% if user.is_authenticated %}
                    <form method="POST" action="" class="flex gap-3 mb-8">
                        {% csrf_token %}
                        <img src="{{ request.user.profile_picture.url }}" alt="User" class="w-10 h-10 rounded-full border border-[1px] border-gray-500 flex-shrink-0 object-cover" />
                        <div class="flex-1 bg-gray-50 border border-gray-300 rounded-xl p-4 shadow-sm">
                            <textarea name="content" rows="2" placeholder="Write a comment..." class="w-full rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-blue-400 focus:outline-none resize-none"></textarea>
                            <div class="flex justify-end mt-3">
                                <button type="submit" class="bg-blue-400 text-white px-3 py-2 rounded-xl hover:bg-blue-500 transition-all text-sm">Post Comment</button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <p class="text-gray-500 italic mb-4">
                        Please
                        <a href="{% url 'login' %}" class="text-blue-600 hover:underline">sign in</a>
                        to comment.
                    </p>
                    {% endif %}

                    <!-- Comment List -->
                    <div id="comment-list" class="space-y-6">
                        {% for comment in all_comments %}
                        <div class="flex flex-col sm:flex-row gap-3 bg-white rounded-md p-4 shadow-sm transition-all">
                            <!-- User Avatar -->
                            <img src="{{ comment.user.profile_picture.url }}" alt="User" class="w-10 h-10 rounded-full border flex-shrink-0" />

                            <!-- Comment Content -->
                            <div class="flex-1">
                                <!-- Header -->
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-1 gap-2">
                                    <!-- Name and time inline -->
                                    <div class="flex items-center gap-5">
                                        <h3 class="font-semibold text-gray-800 text-sm">{{ comment.user.first_name }} {{ comment.user.last_name }}</h3>

                                        <!-- Time ago with green icon -->
                                        <span class="flex items-center gap-1 text-xs text-gray-500 pt-1">
                                            <span class="w-2 h-2 bg-green-500 rounded-full inline-block"></span>
                                            {{ comment.created_at|timesince|slice:":10" }} ago
                                        </span>
                                    </div>
                                </div>

                                <!-- Body -->
                                <p class="text-gray-700 text-sm leading-relaxed">{{ comment.content }}</p>

                                <!-- Actions -->
                                <div class="flex items-center gap-4 text-xs text-gray-500 mt-2">
                                    <button class="hover:text-blue-600 font-medium">Like</button>
                                    <button type="button" class="hover:text-blue-600 font-medium reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                </div>

                                <!-- Reply Form -->
                                <form method="POST" action="" class="hidden reply-form mt-3 flex gap-2">
                                    {% csrf_token %}
                                    <img src="{{ request.user.profile_picture.url }}" class="w-8 h-8 rounded-full border" />
                                    <textarea name="content" rows="1" placeholder="Write a reply..." class="flex-1 rounded-lg px-3 py-2 border border-gray-300 focus:ring-1 focus:ring-blue-400 focus:outline-none text-sm resize-none"></textarea>
                                    <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm">Send</button>
                                </form>

                                <!-- Replies -->
                                {% if comment.replies.all %}
                                <div class="mt-4 ml-6 sm:ml-10 space-y-3">
                                    {% for reply in comment.replies.all %}
                                    <div class="flex gap-3">
                                        <img src="{{ reply.user.profile_picture.url }}" class="w-8 h-8 rounded-full border" />
                                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 flex-1">
                                            <div class="flex justify-between items-center mb-1">
                                                <h4 class="font-semibold text-gray-800 text-sm">{{ reply.user.first_name }}</h4>
                                                <span class="text-xs text-gray-500">{{ reply.created_at|date:"d M Y, h:i A" }}</span>
                                            </div>
                                            <p class="text-gray-700 text-sm">{{ reply.content }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 italic text-center">No comments yet. Be the first to comment!</p>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </main>

        <div class="w-[1px] h-auto bg-gray-200"></div>

        {% comment %} aside button {% endcomment %}
        <aside class="w-full md:w-1/3 mt-8 md:mt-0">
            <div class="bg-gray-200 p-6 flex items-center justify-center h-32">
                <div class="text-center">
                    <img src="https://via.placeholder.com/80x40/FFFFFF/2d3748?text=BSRM" alt="TECHLIFE" class="mx-auto h-10" />
                    <p class="text-sm font-bold text-gray-700 mt-1">ADD</p>
                </div>
            </div>

            {% if word_count < 250 %}
            <div class="mt-5">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Related News</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- related news -->
                {% for news in related_news %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            {% elif word_count >= 250 and word_count <= 600 %}
            <div class="mt-5">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Related News</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- related news -->
                {% for news in related_news %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- mostview -->
            <div class="pt-6">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Most viewed</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- related news -->
                {% for news in most_viewed_blogs|slice:"6" %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            {% elif word_count > 600 and word_count <= 800 %} {% comment %} related newws {% endcomment %}
            <div class="mt-5">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Related News</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- related news -->
                {% for news in related_news %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- mostview -->
            <div class="pt-6">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Most viewed</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- most news -->
                {% for news in most_viewed_blogs|slice:"8" %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <div class="mt-7 flex justify-center items-center w-full mx-auto h-[300px] bg-gray-200">
                <p>Google Add section</p>
            </div>

            {% elif word_count > 800 %} {% comment %} related newws {% endcomment %}
            <div class="mt-5">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Related News</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- related news -->
                {% for news in related_news %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- mostview -->
            <div class="pt-6">
                <div>
                    <h2 class="text-[22px] font-bold text-gray-900 mb-1 font-inter">Most viewed</h2>
                </div>
                <div class="flex flex-col mb-4">
                    <div class="absolute w-[120px] h-[2px] bg-blue-600"></div>
                    <div class="w-full h-[2px] bg-gray-300"></div>
                </div>

                <!-- most news -->
                {% for news in most_viewed_blogs|slice:"10" %}
                <a href="{% url 'blog-details' news.slug %}" class="flex items-start mb-4 border-b pb-3 relative group">
                    <div class="w-[120px] h-[73px] min-w-[120px] flex-shrink-0 overflow-hidden rounded-md transform transition-transform duration-300 ease-out group-hover:-translate-y-1 group-hover:scale-100">
                        <img class="w-full h-full object-cover block" src="{{ news.featured_image_url }}" alt="{{ news.title }}" />
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-800 hover:text-blue-600 cursor-pointer line-clamp-2">{{ news.title }}</p>
                        <span class="text-[11px] text-gray-800">{{ news.created_at|date:"d M Y, h:i A" }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>

            <div class="mt-7 flex justify-center items-center w-full mx-auto h-[300px] bg-gray-200">
                <p>Google Add section</p>
            </div>
            {% endif %}
        </aside>
    </div>
</div>

<!-- audio control -->
<script>
    let speech = null;
    // নতুন: টাইটেল এলিমেন্টটি সিলেক্ট করা
    const titleElement = document.getElementById('blog-title');
    const descriptionElement = document.getElementById('blog-description');
    const mainAudioBtn = document.getElementById('main-audio-btn');
    const stopBtn = document.getElementById('stop-btn');
    const iconDisplay = document.getElementById('icon-display');
    const synth = window.speechSynthesis;

    // Button State এবং Icon Update Function (আগের মতোই থাকবে)
    function updateUI(isSpeaking, isPaused) {
        if (isSpeaking) {
            if (isPaused) {
                iconDisplay.textContent = '▶';
                mainAudioBtn.title = 'Resume';
            } else {
                iconDisplay.textContent = '⏸';
                mainAudioBtn.title = 'Pause';
            }
            stopBtn.disabled = false;
        } else {
            iconDisplay.textContent = '▶';
            mainAudioBtn.title = 'Listen';
            stopBtn.disabled = true;
        }
    }

    // Main Button Click Event
    mainAudioBtn.addEventListener('click', () => {
        // A. যদি Pause করা থাকে, তাহলে Resume করো
        if (synth.paused) {
            synth.resume();
            updateUI(true, false);
            return;
        }

        // B. যদি কথা বলছে, তাহলে Pause করো
        if (synth.speaking) {
            synth.pause();
            updateUI(true, true);
            return;
        }

        // C. নতুন: টাইটেল এবং ডেসক্রিপশন একসাথে আনা
        const titleText = titleElement ? titleElement.textContent : '';
        const descriptionText = descriptionElement ? descriptionElement.textContent : '';

        // টাইটেল, তারপর একটি বিরামচিহ্ন (যেমন পূর্ণচ্ছেদ বা কোলন) এবং ডেসক্রিপশন যোগ করা
        // এতে পড়ার সময় একটি ছোট পজ (বিরতি) হবে।
        const textToSpeak = titleText + '. ' + descriptionText;

        // যদি কোনো টেক্সট না থাকে, তাহলে কিছু করার দরকার নেই
        if (!textToSpeak.trim()) {
            console.warn('No text content found to speak.');
            return;
        }

        // D. বলা শুরু করো
        speech = new SpeechSynthesisUtterance(textToSpeak);
        speech.lang = 'bn-BD'; // বাংলা ভাষা সেট করুন

        synth.speak(speech);
        updateUI(true, false);

        // E. বলা শেষ হলে UI রিসেট করো
        speech.onend = () => {
            updateUI(false, false);
        };

        // Error হলে
        speech.onerror = (event) => {
            console.error('Speech synthesis error:', event);
            updateUI(false, false);
        };
    });

    // 3. Stop Button Click Event (সমস্ত কিছু বন্ধ করতে) (আগের মতোই থাকবে)
    stopBtn.addEventListener('click', () => {
        if (synth.speaking || synth.paused) {
            synth.cancel();
            updateUI(false, false);
        }
    });

    // Initial state set করা
    updateUI(false, false);
</script>

{% comment %} emoji picker of blog comment {% endcomment %}
<script>
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const messageInput = document.getElementById('messageInput');

    // Add emoji picker inside container
    emojiPicker.innerHTML = `<emoji-picker style="width: 300px; height: 350px;"></emoji-picker>`;
    const picker = emojiPicker.querySelector('emoji-picker');

    emojiBtn.addEventListener('click', () => {
        emojiPicker.classList.toggle('hidden');
    });

    picker.addEventListener('emoji-click', (event) => {
        messageInput.value += event.detail.unicode;
    });

    const fileBtn = document.getElementById('fileBtn');
    const hiddenFileInput = document.getElementById('hiddenFileInput');

    fileBtn.addEventListener('click', () => {
        hiddenFileInput.click();
    });

    hiddenFileInput.addEventListener('change', (e) => {
        const fileName = e.target.files[0]?.name;
        if (fileName) alert(`📎 Selected file: ${fileName}`);
    });
</script>

{% comment %} share section {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const shareBtn = document.getElementById('shareBtn'); // je button e click kore modal khulbe
        const shareModal = document.getElementById('shareModal');
        const closeModal = document.getElementById('closeModal');
        const shareLinks = document.querySelectorAll('.share-link');

        const postUrl = encodeURIComponent(window.location.href);
        const postId = '{{ blog_detail.id }}'; // Django template variable for current post

        // Open modal
        shareBtn.addEventListener('click', () => {
            shareModal.classList.remove('hidden');
        });

        // Close modal on X button
        closeModal.addEventListener('click', () => {
            shareModal.classList.add('hidden');
        });

        // Close modal if click outside modal box
        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.classList.add('hidden');
            }
        });

        // Share links
        shareLinks.forEach((link) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const platform = link.dataset.platform;
                let url = '';

                // 1️⃣ Open social share popup
                switch (platform) {
                    case 'facebook':
                        url = `https://www.facebook.com/sharer/sharer.php?u=${postUrl}`;
                        break;
                    case 'linkedin':
                        url = `https://www.linkedin.com/shareArticle?mini=true&url=${postUrl}`;
                        break;
                    case 'twitter':
                        url = `https://twitter.com/intent/tweet?url=${postUrl}`;
                        break;
                    case 'whatsapp':
                        url = `https://api.whatsapp.com/send?text=${postUrl}`;
                        break;
                }
                window.open(url, '_blank', 'width=600,height=400');

                // 2️⃣ Record share in backend (AJAX)
                fetch("{% url 'share_post' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `post_id=${postId}&platform=${platform}`
                })
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.status === 'success') {
                            console.log(`Share recorded on ${platform}!`);
                        } else {
                            console.error('Share record failed:', data.message);
                        }
                    })
                    .catch((err) => console.error('AJAX error:', err));
            });
        });
    });
</script>

{% comment %} save sectioin {% endcomment %}

<script>
    function saveModalHandler(postId, userAuthenticated) {
        return {
            modalOpen: false,
            toastOpen: false,
            toastMessage: '',
            postId: postId,
            userAuthenticated: userAuthenticated,
            checkAndOpen() {
                if (!this.userAuthenticated) {
                    this.modalOpen = true;
                    return;
                }
                // Already saved check
                fetch(`/check-saved/${this.postId}/`)
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.already_saved) {
                            this.showToast('This post is already saved. Check your profile.');
                        } else {
                            this.modalOpen = true;
                        }
                    });
            },
            savePost() {
                if (!this.userAuthenticated) return;

                fetch("{% url 'save_post' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ post_id: this.postId })
                })
                    .then((res) => res.json())
                    .then((data) => {
                        this.modalOpen = false;
                        if (data.status === 'success') {
                            this.showToast('Post saved successfully!');
                        } else if (data.status === 'exists') {
                            this.showToast('This post is already saved. Check your profile.');
                        } else {
                            this.showToast('Error: ' + data.message);
                        }
                    })
                    .catch((err) => console.error(err));
            },
            showToast(message) {
                this.toastMessage = message;
                this.toastOpen = true;
                setTimeout(() => (this.toastOpen = false), 4000);
            }
        };
    }
</script>

<!-- Reply Toggle Script -->
<script>
    document.querySelectorAll('.reply-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
            const form = btn.closest('div').parentNode.querySelector('.reply-form');
            form.classList.toggle('hidden');
        });
    });
</script>

{% endblock content %}
